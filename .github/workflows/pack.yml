name: Pack CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check portable .claude repo shape
        run: python scripts/check_portable_claude.py

      - name: Lint .claude frontmatter
        run: python scripts/lint_frontmatter.py

      - name: Validate agent prompts
        run: python scripts/validate_agent_prompts.py

  pack-check:
    # Windows CI catches platform-specific path handling and bash compatibility issues
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            tools/demoswarm-pack-check

      - name: Run pack self-check
        shell: bash
        run: bash .claude/scripts/pack-check.sh --no-color

  demoswarm-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            tools/demoswarm-runs-tools

      - name: Install demoswarm CLI
        run: cargo install --path tools/demoswarm-runs-tools --root .demoswarm

      - name: Smoke test - time command
        run: bash .claude/scripts/demoswarm.sh time now

      - name: Smoke test - count command
        run: bash .claude/scripts/demoswarm.sh count pattern --file CLAUDE.md --regex '^#'

  runs-tools-tests:
    # Rust tests run on both platforms to catch cross-platform issues
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            tools/demoswarm-runs-tools

      - name: Run runs-tools tests
        run: cargo test --manifest-path tools/demoswarm-runs-tools/Cargo.toml

  pack-check-tests:
    # Rust tests run on both platforms to catch cross-platform issues
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            tools/demoswarm-pack-check

      - name: Run pack-check tests
        run: cargo test --manifest-path tools/demoswarm-pack-check/Cargo.toml

  cargo-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            tools/demoswarm-pack-check
            tools/demoswarm-runs-tools

      - name: Install cargo-audit
        run: cargo install cargo-audit@0.22.0

      - name: Audit demoswarm-pack-check
        run: cd tools/demoswarm-pack-check && cargo audit

      - name: Audit demoswarm-runs-tools
        run: cd tools/demoswarm-runs-tools && cargo audit

  doc-drift:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for doc drift
        run: bash scripts/check-doc-drift.sh
